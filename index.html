<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>放射科預假單系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .date-header {
            width: 90px; min-width: 90px; overflow: hidden; white-space: nowrap;
            text-align: center; padding: 6px 0; border-bottom: 1px solid #e5e7eb;
            font-size: 0.8rem; vertical-align: top;
        }
        .name-header {
            width: 100px; min-width: 100px; text-align: left; padding: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        .order-header {
            width: 50px; min-width: 50px; text-align: center; padding: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        .data-cell {
            width: 90px; height: 36px; text-align: center;
            border-bottom: 1px solid #f3f4f6; padding: 0; cursor: pointer;
            position: relative; 
        }
        .name-cell {
            text-align: left; padding-left: 8px; font-weight: 500;
            border-bottom: 1px solid #f3f4f6; height: 36px; line-height: 36px;
        }
        .order-cell {
            text-align: center; border-bottom: 1px solid #f3f4f6;
            height: 36px; line-height: 36px;
        }
        .weekend { background-color: #f9fafb; }
        .holiday { background-color: #fffbeb; border: 1px dashed #facc15; }
        .holiday-name {
            display: block; font-size: 0.65rem; color: #d97706;
            margin-top: 2px; white-space: normal;
        }
        .leave-form-container {
            margin-bottom: 30px; 
            padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px;
            background-color: white; overflow-x: auto;
        }
        .form-title { 
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #374151;
        }
        .leave-mark-display {
            color: white; font-weight: bold; border-radius: 4px; width: 80%; height: 80%;
            margin: auto; display: flex; align-items: center; justify-content: center; font-size: 0.9rem;
        }
        .leave-mark-G { background-color: #f472b6; } .leave-mark-A { background-color: #60a5fa; }
        .leave-mark-C { background-color: #34d399; }
        .leave-type-popover {
            position: absolute; background-color: white; border: 1px solid #cbd5e1; 
            border-radius: 6px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 8px; z-index: 1000; display: flex; flex-direction: column; gap: 4px; min-width: 100px;
        }
        .leave-type-popover button {
            padding: 6px 10px; border: 1px solid transparent; border-radius: 4px; text-align: left;
            cursor: pointer; font-size: 0.875rem; background-color: #f9fafb; 
            transition: background-color 0.2s, border-color 0.2s; color: #374151;
        }
        .leave-type-popover button:hover { background-color: #f3f4f6; border-color: #e5e7eb; }
        .leave-type-popover button.popover-leave-type-btn { color: white; }
        .leave-type-popover button.popover-clear-btn { background-color: #e5e7eb; }
        .leave-type-popover button.popover-clear-btn:hover { background-color: #d1d5db; }
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="mx-auto max-w-full lg:max-w-7xl">
        <h1 class="text-2xl font-semibold text-center text-gray-800 mb-6">放射科預假單系統</h1>
        <p id="main-instruction" class="text-gray-600 text-sm mb-4 text-center">
            </p>
        <p class="text-gray-500 text-xs mb-4 text-center">（註：假日列表為2025年台灣國定假日參考，實際標示依各表單日期範圍為準。）</p>

        <div id="leave-forms-container">
            </div>
    </div>

    <script>
        const leaveFormsContainer = document.getElementById('leave-forms-container');
        const mainInstruction = document.getElementById('main-instruction');

        const today = new Date(); // 在此模擬情境中，此為 2025年5月20日
        today.setHours(0, 0, 0, 0); 

        const appCurrentYear = today.getFullYear(); 
        const initialGlobalStartDate = new Date(appCurrentYear, 5, 9); // 2025年6月9日 (月份5代表6月)
        
        const numberOfDaysPerForm = 28;
        const numberOfFormsToAttempt = 5; // 希望顯示的有效表單數量上限

        // --- 更新主要提示文字 ---
        const startDateTextForInstruction = initialGlobalStartDate.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
        if (mainInstruction) {
            mainInstruction.innerHTML = `
                系統將顯示最多${numberOfFormsToAttempt}份連續的28天預假單。首份預計起始日期為：<span id="initial-start-date-display" class="font-bold">${startDateTextForInstruction}</span>。
                <br>點擊儲存格可選擇休假類型 <span class="font-bold text-gray-700">(般: 一般假, 年: 年休, 補: 補休)</span>。
                <br><span class="text-xs text-red-600">注意：根據規則，起始日期早於「今天」的表單（已過期）將不會顯示。</span>`;
        }

        const leaveTypes = [
            { code: '般', name: '一般假', color: '#f472b6', className: 'leave-mark-G' },
            { code: '年', name: '年休',   color: '#60a5fa', className: 'leave-mark-A' },
            { code: '補', name: '補休',   color: '#34d399', className: 'leave-mark-C' }
        ];
        let currentPopover = null;    
        let popoverTargetCell = null; 

        const holidaysWithNames = [ /* ... 假日列表保持不變 ... */
            { date: `${appCurrentYear}-01-01`, name: "元旦" }, { date: `${appCurrentYear}-01-28`, name: "除夕" },
            { date: `${appCurrentYear}-01-29`, name: "春節" }, { date: `${appCurrentYear}-01-30`, name: "春節" },
            { date: `${appCurrentYear}-01-31`, name: "春節" }, { date: `${appCurrentYear}-02-28`, name: "和平紀念日" },
            { date: `${appCurrentYear}-04-04`, name: "兒童節/清明節" }, { date: `${appCurrentYear}-05-01`, name: "勞動節" },
            { date: `${appCurrentYear}-05-30`, name: "端午節(補假)" }, { date: `${appCurrentYear}-05-31`, name: "端午節" },
            { date: `${appCurrentYear}-10-06`, name: "中秋節" }, { date: `${appCurrentYear}-10-10`, name: "國慶日" }
        ];
        const employees = [ /* ... 員工列表保持不變 ... */
            { name: "陳振堅", order: 1 }, { name: "莊憶如", order: 2 }, { name: "朱雁翎", order: 3 },
            { name: "曾紹華", order: 4 }, { name: "李國偉", order: 5 }, { name: "洪藝瑄", order: 6 },
            { name: "高元宏", order: 7 }, { name: "傅奎愿", order: 8 }, { name: "陳盈熹", order: 9 },
            { name: "蔡芳綺", order: 10 }, { name: "李宛融", order: 11 }, { name: "徐啟仁", order: 12 },
            { name: "鄭璟樺", order: 13 },
        ];

        function generateDatesForForm(formStartDate, numDays) { /* ... 此函數保持不變 ... */
            const datesArray = [];
            for (let i = 0; i < numDays; i++) {
                const date = new Date(formStartDate);
                date.setDate(formStartDate.getDate() + i);
                datesArray.push(date);
            }
            return datesArray;
        }
        function createDateHeadersHTML(currentFormDates) { /* ... 此函數保持不變 ... */
            let headerContent = `<table class="min-w-full table-fixed">
                <thead>
                    <tr>
                        <th class="name-header">姓名</th>
                        <th class="order-header">順位</th>`;
            currentFormDates.forEach(date => {
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const year = date.getFullYear();
                const displayDate = `${month}/${day}`;
                const dayOfWeek = date.toLocaleDateString('zh-TW', { weekday: 'short' });
                let cellClass = "";
                let holidayNameHTML = "";
                const dateKey = `${year}-${month}-${day}`;

                if (date.getDay() === 0 || date.getDay() === 6) cellClass += " weekend";
                
                const holidayInfo = holidaysWithNames.find(h => h.date === dateKey);
                if (holidayInfo) {
                    cellClass += " holiday";
                    holidayNameHTML = `<span class="holiday-name">${holidayInfo.name}</span>`;
                }
                headerContent += `<th class="date-header${cellClass}">
                                    ${displayDate}<br><span class="text-xs">(${dayOfWeek})</span>${holidayNameHTML}
                                  </th>`;
            });
            headerContent += `</tr></thead>`;
            return headerContent;
        }
        function closeActivePopover() { /* ... 此函數保持不變 ... */
            if (currentPopover) {
                currentPopover.remove();
                currentPopover = null;
                popoverTargetCell = null;
            }
        }
        
        function createLeaveForm(formStartDate, formIndex) { /* ... 此函數內部關於表單結構和點擊儲存格的邏輯保持不變 ... */
            const formElement = document.createElement('div');
            formElement.className = 'leave-form-container';
            const currentFormDates = generateDatesForForm(formStartDate, numberOfDaysPerForm);
            const formTitleElement = document.createElement('h3');
            formTitleElement.className = 'form-title';
            const endDateOfThisForm = currentFormDates[currentFormDates.length - 1];
            const startDateString = formStartDate.toLocaleDateString('zh-TW', { year: 'numeric', month: 'numeric', day: 'numeric' });
            const endDateString = endDateOfThisForm.toLocaleDateString('zh-TW', { year: 'numeric', month: 'numeric', day: 'numeric' });
            formTitleElement.textContent = `預假單 ${formIndex + 1} ( ${startDateString} - ${endDateString} )`;
            formElement.appendChild(formTitleElement);
            let tableHTML = createDateHeadersHTML(currentFormDates);
            tableHTML += `<tbody>`;
            employees.forEach(employee => {
                tableHTML += `<tr><td class="name-cell">${employee.name}</td><td class="order-cell">${employee.order}</td>`;
                currentFormDates.forEach(date => {
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const year = date.getFullYear();
                    const dateKey = `${year}-${month}-${day}`;
                    let cellClasses = "data-cell";
                    if (date.getDay() === 0 || date.getDay() === 6) cellClasses += " weekend";
                    if (holidaysWithNames.find(h => h.date === dateKey)) cellClasses += " holiday";
                    tableHTML += `<td class="${cellClasses}" data-date="${dateKey}"></td>`;
                });
                tableHTML += `</tr>`;
            });
            tableHTML += `</tbody></table>`;
            const tableContainer = document.createElement('div');
            tableContainer.innerHTML = tableHTML;
            formElement.appendChild(tableContainer.firstChild);
            leaveFormsContainer.appendChild(formElement);

            const dataCells = formElement.querySelectorAll('.data-cell');
            dataCells.forEach(cell => {
                cell.addEventListener('click', function (event) {
                    event.stopPropagation(); 
                    if (popoverTargetCell === this && currentPopover) {
                        closeActivePopover(); return;
                    }
                    closeActivePopover(); 
                    popoverTargetCell = this; 
                    const popover = document.createElement('div');
                    popover.className = 'leave-type-popover';
                    leaveTypes.forEach(lt => {
                        const btn = document.createElement('button');
                        btn.textContent = lt.name;
                        btn.dataset.leaveCode = lt.code;
                        btn.dataset.leaveClassName = lt.className;
                        btn.style.backgroundColor = lt.color; 
                        btn.classList.add('popover-leave-type-btn');
                        btn.onclick = function() {
                            popoverTargetCell.innerHTML = ''; 
                            leaveTypes.forEach(type => popoverTargetCell.classList.remove(type.className));
                            const leaveMarkDiv = document.createElement('div');
                            leaveMarkDiv.className = 'leave-mark-display ' + this.dataset.leaveClassName;
                            leaveMarkDiv.textContent = this.dataset.leaveCode;
                            popoverTargetCell.appendChild(leaveMarkDiv);
                            popoverTargetCell.dataset.selectedLeave = this.dataset.leaveCode; 
                            closeActivePopover();
                        };
                        popover.appendChild(btn);
                    });
                    const clearBtn = document.createElement('button');
                    clearBtn.textContent = '清除';
                    clearBtn.classList.add('popover-clear-btn'); 
                    clearBtn.onclick = function() {
                        popoverTargetCell.innerHTML = '';
                        leaveTypes.forEach(type => popoverTargetCell.classList.remove(type.className));
                        delete popoverTargetCell.dataset.selectedLeave;
                        closeActivePopover();
                    };
                    popover.appendChild(clearBtn);
                    document.body.appendChild(popover);
                    currentPopover = popover;
                    const rect = this.getBoundingClientRect();
                    let topPosition = rect.bottom + window.scrollY + 2; 
                    let leftPosition = rect.left + window.scrollX;
                    popover.style.top = `${topPosition}px`;
                    popover.style.left = `${leftPosition}px`;
                    const popoverRect = popover.getBoundingClientRect();
                    if (popoverRect.right > window.innerWidth - 10) { 
                        popover.style.left = `${window.innerWidth - popoverRect.width - 10}px`;
                    }
                    if (popoverRect.left < 10) { popover.style.left = '10px'; }
                    if (popoverRect.bottom > window.innerHeight -10 ) {
                         popover.style.top = `${rect.top + window.scrollY - popoverRect.height - 2}px`; 
                    }
                     if (popoverRect.top < 10 && (rect.top + window.scrollY - popoverRect.height - 2) < 10 ) {
                        popover.style.top = '10px';
                    }
                });
            });
        }

        // --- 修改表單生成迴圈以應用「過期」規則 ---
        let dateForNextForm = new Date(initialGlobalStartDate);
        let validFormsCount = 0; // 計算實際創建的有效表單數量

        // 迴圈嘗試為 numberOfFormsToAttempt 個 "槽位" 生成表單
        // 但只有當表單未過期時，才會真正創建並計入 validFormsCount
        for (let slotIndex = 0; slotIndex < numberOfFormsToAttempt; slotIndex++) {
            if (validFormsCount >= numberOfFormsToAttempt) {
                break; // 如果已經創建了足夠的有效表單，則停止
            }

            const potentialStartDate = new Date(dateForNextForm);
            potentialStartDate.setHours(0, 0, 0, 0); // 標準化日期以供比較

            // 規則：如果表單的第一天日期「早於」(小於) 今天，則視為過期，跳過。
            if (potentialStartDate < today) {
                console.log(`預計表單起始日: ${potentialStartDate.toLocaleDateString('zh-TW')} 已過期 (早於今天 ${today.toLocaleDateString('zh-TW')})，將被跳過。`);
                dateForNextForm.setDate(dateForNextForm.getDate() + numberOfDaysPerForm); // 為下一個潛在的槽位準備日期
                // 注意：這裡我們消耗了一個 slotIndex，但未增加 validFormsCount
                // 因此，如果 initialGlobalStartDate 很早，最終有效表單可能少於 numberOfFormsToAttempt
                continue; // 跳過創建此已過期表單，檢查下一個槽位
            }

            // 如果執行到這裡，表示 potentialStartDate >= today，此表單有效
            createLeaveForm(new Date(potentialStartDate), validFormsCount); // 使用 validFormsCount 作為表單標題的索引
            validFormsCount++;
            dateForNextForm.setDate(dateForNextForm.getDate() + numberOfDaysPerForm); // 為下一個槽位準備日期
        }


        if (validFormsCount === 0) {
            const noFormsMessage = document.createElement('p');
            noFormsMessage.className = 'text-center text-red-600 font-semibold py-4';
            noFormsMessage.textContent = '根據目前設定與日期規則，沒有可顯示的預假單。';
            leaveFormsContainer.appendChild(noFormsMessage);
            if (mainInstruction) {
                 mainInstruction.innerHTML += '<br><strong class="text-red-700">目前沒有表單可供填寫。</strong>';   
            }
        }

        document.addEventListener('click', function(event) { /* ... 全域點擊關閉選單邏輯保持不變 ... */
            if (currentPopover && !currentPopover.contains(event.target) && event.target !== popoverTargetCell) {
                 if (popoverTargetCell && !popoverTargetCell.contains(event.target)) {
                    closeActivePopover();
                } else if (!popoverTargetCell) { 
                    closeActivePopover();
                }
            }
        });
    </script>
</body>
</html>